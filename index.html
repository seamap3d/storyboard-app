<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <title>ApeOnAWhale Storyboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --frame-aspect: calc(9/16); }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .frame { aspect-ratio: 16 / 9; background: repeating-linear-gradient(45deg, #0f172a, #0f172a 8px, #111827 8px, #111827 16px); }
    .grain::after { content:""; position:absolute; inset:0; background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0.06"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>'); mix-blend-mode:overlay; opacity:.6; pointer-events:none; }
  .ellipsis { display:-webkit-box; -webkit-line-clamp:2; line-clamp: 2; -webkit-box-orient:vertical; overflow:hidden; }
    .handle { cursor: grab; }
    .handle:active { cursor: grabbing; }
    .kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.125rem 0.5rem;
      border-radius: 0.375rem;
      background: #1e293b;
      color: #f1f5f9;
      font-size: 0.75rem;
      border: 1px solid #334155;
      font-weight: 500;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="w-full px-4 md:px-6 py-4">
    <header class="flex items-center justify-between gap-3 mb-4">
  <h1 class="text-2xl md:text-3xl font-black tracking-tight">ðŸŽ¬ ApeOnAWhale Storyboard</h1>
      <div class="flex items-center gap-2">
        <button id="btnNew" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold shadow">New Shot</button>
        <button id="btnImport" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">Import JSON</button>
        <button id="btnExport" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">Export JSON</button>
        <button id="btnPrint" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">Print / PDF</button>
        <button id="btnReset" class="px-3 py-2 rounded-xl bg-rose-700 hover:bg-rose-600 text-white font-semibold border border-rose-500/80">Reset Storyboard</button>
      </div>
    </header>

  <!-- Project Panel -->
    <section class="mb-6">
      <div class="p-4 rounded-2xl bg-slate-900/60 border border-slate-800 shadow">
        <h2 class="font-semibold mb-3">Project</h2>
        <div class="grid grid-cols-2 gap-3">
          <label class="col-span-2">
            <span class="text-sm text-slate-300">Title</span>
            <input id="projTitle" class="mt-1 w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="Project Title (working title)">
          </label>
          <label>
            <span class="text-sm text-slate-300">Director</span>
            <input id="director" class="mt-1 w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="Director name">
          </label>
          <label>
            <span class="text-sm text-slate-300">Production Company</span>
            <input id="productionCompany" class="mt-1 w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="Company or production house">
          </label>
          <label>
            <span class="text-sm text-slate-300">Director of Photography</span>
            <input id="dop" class="mt-1 w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="Cinematographer / DOP">
          </label>
          <label>
            <span class="text-sm text-slate-300">Producer</span>
            <input id="producer" class="mt-1 w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="Producer or production lead">
          </label>
          <label class="col-span-2">
            <span class="text-sm text-slate-300">Shooting Schedule</span>
            <input id="shootSchedule" class="mt-1 w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="e.g., May 12 â€“ May 18, 2026">
          </label>
          <label class="col-span-2">
            <span class="text-sm text-slate-300">Production Notes</span>
            <textarea id="projNotes" rows="2" class="mt-1 w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" placeholder="Logistics, key contacts, or other notes"></textarea>
          </label>
        </div>
        <div class="mt-3 text-xs text-slate-400">Tip: Press <span class="kbd">N</span> for a new shot, <span class="kbd">E</span> to export, <span class="kbd">P</span> to print.</div>
      </div>
    </section>
      <section class="p-4 rounded-2xl bg-slate-900/60 border border-slate-800 shadow mb-6">
        <h2 class="font-semibold mb-2">Working from ChatGPT</h2>
        <p class="text-sm text-slate-300">You can ask ChatGPT to turn your script into a storyboard JSON using the same schema this app exports. Save that response as a <code class="text-xs bg-slate-800/80 px-1 py-0.5 rounded">.json</code> file and load it here with <strong>Import JSON</strong>.</p>
        <p class="text-xs text-slate-400 mt-2">Tip: Request a <code>shots</code> array with fields like <em>scene</em>, <em>type</em>, <em>lens</em>, <em>move</em>, <em>desc</em>, and any other production notes you need.</p>
      </section>
    <!-- Shot list -->
    <section>
      <div class="flex flex-wrap items-center justify-between gap-3 mb-2">
        <h2 class="font-semibold">Shots</h2>
        <div class="flex flex-wrap items-center gap-3">
          <label class="flex items-center gap-2 text-xs text-slate-400">
            <span>Layout</span>
            <select id="layoutSelect" class="px-2 py-1 rounded-lg bg-slate-900 border border-slate-700 text-slate-200 text-sm">
              <option value="1">1 per row</option>
              <option value="2">2 per row</option>
              <option value="3">3 per row</option>
            </select>
          </label>
          <span class="text-xs text-slate-400">Drag the handle to reorder shots.</span>
          <button id="btnSelectAll" class="px-2 py-1 text-xs rounded-lg border border-slate-700 text-slate-200 hover:bg-slate-800">Select All</button>
          <button id="btnFoldSelected" class="px-2 py-1 text-xs rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200">Fold Selected</button>
          <button id="btnUnfoldSelected" class="px-2 py-1 text-xs rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200">Unfold Selected</button>
          <button id="btnClearSelection" class="px-2 py-1 text-xs rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-800">Clear Selection</button>
        </div>
      </div>
    <ol id="shotList" class="grid gap-4 list-none"></ol>
    </section>
  </div>

  <template id="shotTmpl">
    <li class="shot group p-4 border border-slate-800 rounded-2xl shadow transition-colors ring-1 ring-transparent text-[0.8rem]">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div class="flex items-center gap-3">
          <input type="checkbox" class="select-shot w-5 h-5 accent-emerald-500 focus:ring-emerald-500/40 rounded">
          <div class="shot-title text-sm font-semibold uppercase tracking-wide text-slate-900/80">Shot</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="btnToggleFold px-2 py-1 text-xs rounded-lg border border-slate-900/30 text-slate-900/70 hover:bg-slate-900/10">Fold</button>
          <div class="handle shrink-0 select-none text-slate-700 hover:text-slate-900 cursor-grab active:cursor-grabbing">â‰¡</div>
        </div>
      </div>
      <div class="frame grain rounded-xl ring-1 ring-slate-900/20 overflow-hidden flex items-center justify-center text-slate-500 relative group aspect-video">
        <img class="frame-image absolute inset-0 w-full h-full object-cover hidden" alt="Shot reference">
        <div class="text-center px-4 frame-placeholder space-y-2">
          <div class="font-semibold text-slate-600">Frame Preview</div>
          <div class="text-xs text-slate-500">16:9 placeholder with film grain</div>
          <label class="inline-block px-3 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg cursor-pointer text-xs font-medium">
            Upload Image
            <input type="file" accept="image/*" class="image-upload hidden">
          </label>
        </div>
        <button class="remove-image absolute top-2 right-2 w-8 h-8 bg-rose-600 hover:bg-rose-500 text-white rounded-full items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity hidden">Ã—</button>
      </div>
      <div class="shot-body space-y-3 mt-4 text-[0.85em]">
        <div class="grid grid-cols-2 gap-3">
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Scene</span>
            <input class="inp scene mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" placeholder="EXT. LOCATION â€“ TIME">
          </label>
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Shot #</span>
            <input class="inp shotnum mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" placeholder="1">
          </label>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Shot Type</span>
            <select class="inp type mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800">
              <option>Wide</option>
              <option>Establishing</option>
              <option>Medium</option>
              <option>Closeâ€‘Up</option>
              <option>Extreme CU</option>
              <option>Overâ€‘theâ€‘Shoulder</option>
              <option>POV</option>
              <option>Drone</option>
              <option>Insert</option>
            </select>
          </label>
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Lens</span>
            <select class="inp lens mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800">
              <option>24mm</option>
              <option selected>35mm</option>
              <option>50mm</option>
              <option>85mm</option>
              <option>105mm</option>
            </select>
          </label>
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Move</span>
            <select class="inp move mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800">
              <option>Locked</option>
              <option>Pan</option>
              <option>Tilt</option>
              <option>Dolly</option>
              <option>Handheld</option>
              <option>Crane</option>
              <option>Drone</option>
            </select>
          </label>
        </div>
        <label>
          <span class="text-xs uppercase tracking-wide text-slate-700">Action / Composition</span>
          <textarea class="inp desc mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" rows="3" placeholder="Describe the shot composition, action, and visual elements."></textarea>
        </label>
        <div class="grid grid-cols-2 gap-3">
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Cast / Characters</span>
            <input class="inp chars mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" placeholder="Character A, Character B">
          </label>
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Location</span>
            <input class="inp location mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" placeholder="Set or shooting location">
          </label>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Shooting Date</span>
            <input type="date" class="inp shootdate mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800">
          </label>
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Equipment</span>
            <textarea class="inp equipment mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" rows="2" placeholder="Cameras, lenses, rigs, audio"></textarea>
          </label>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Props</span>
            <textarea class="inp props mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" rows="2" placeholder="Key props, wardrobe, set dressing"></textarea>
          </label>
          <label>
            <span class="text-xs uppercase tracking-wide text-slate-700">Production Notes</span>
            <textarea class="inp notes mt-1 w-full px-3 py-2 rounded-lg bg-white border border-slate-900/20 text-slate-800 placeholder:text-slate-400" rows="2" placeholder="Call times, contacts, special considerations"></textarea>
          </label>
        </div>
        <div class="flex items-center gap-2 pt-1">
          <button class="btnDup px-3 py-2 rounded-xl bg-white/60 hover:bg-white/80 border border-slate-900/10 text-slate-800">Duplicate</button>
          <button class="btnDelete px-3 py-2 rounded-xl bg-rose-600/90 hover:bg-rose-600 text-white">Delete</button>
        </div>
      </div>
    </li>
  </template>

  <input type="file" id="fileInput" accept="application/json" class="hidden" />
  <script>
  // --- State ---
  const STORAGE_KEY = 'apeOnAWhaleStoryboard';
  const LEGACY_STORAGE_KEY = 'grittyStoryboard';
  let isHydrating = false;

  const state = {
    shots: [],
    layoutColumns: 1,
    sceneColors: {},
  };

  // --- Elements ---
  const shotList = document.getElementById('shotList');
  const tmpl = document.getElementById('shotTmpl');
  const btnNew = document.getElementById('btnNew');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const btnPrint = document.getElementById('btnPrint');
  const btnReset = document.getElementById('btnReset');
  const btnSelectAll = document.getElementById('btnSelectAll');
  const btnFoldSelected = document.getElementById('btnFoldSelected');
  const btnUnfoldSelected = document.getElementById('btnUnfoldSelected');
  const btnClearSelection = document.getElementById('btnClearSelection');
  const layoutSelect = document.getElementById('layoutSelect');
  const fileInput = document.getElementById('fileInput');
  const projTitle = document.getElementById('projTitle');
  const director = document.getElementById('director');
  const productionCompany = document.getElementById('productionCompany');
  const dop = document.getElementById('dop');
  const producer = document.getElementById('producer');
  const shootSchedule = document.getElementById('shootSchedule');
  const projNotes = document.getElementById('projNotes');
  // --- Helpers ---
  const uid = () => Math.random().toString(36).slice(2,9);

  function updateShotTitle(li) {
    const titleEl = li.querySelector('.shot-title');
    if (!titleEl) return;
    const sceneVal = li.querySelector('.scene')?.value.trim() || '';
    const shotNumVal = li.querySelector('.shotnum')?.value.trim() || '';
    let label = sceneVal;
    if (!label) {
      const index = Array.from(shotList.children).indexOf(li);
      const fallbackNumber = index > -1 ? index + 1 : shotNumVal || '';
      label = fallbackNumber ? `Shot ${fallbackNumber}` : 'Shot';
    }
    titleEl.textContent = label;
  }

  function setShotFolded(li, folded) {
    const isFolded = Boolean(folded);
    const body = li.querySelector('.shot-body');
    const toggle = li.querySelector('.btnToggleFold');
    li.dataset.folded = isFolded ? 'true' : 'false';
    if (body) body.classList.toggle('hidden', isFolded);
    if (toggle) {
      toggle.textContent = isFolded ? 'Unfold' : 'Fold';
      toggle.setAttribute('aria-expanded', (!isFolded).toString());
      toggle.setAttribute('aria-label', isFolded ? 'Unfold shot details' : 'Fold shot details');
    }
    li.classList.toggle('opacity-60', isFolded);
  }

  function updateShotSelectionVisual(li, selected) {
    if (!li) return;
    li.classList.toggle('ring-2', selected);
    li.classList.toggle('ring-emerald-400', selected);
    li.classList.toggle('ring-opacity-60', selected);
  }

  function getSelectedShotLis() {
    return Array.from(shotList.querySelectorAll('.select-shot:checked')).map(cb => cb.closest('li')).filter(Boolean);
  }

  function clearShotSelection() {
    shotList.querySelectorAll('.select-shot').forEach(cb => {
      cb.checked = false;
      updateShotSelectionVisual(cb.closest('li'), false);
    });
  }

  function selectAllShots() {
    shotList.querySelectorAll('.select-shot').forEach(cb => {
      cb.checked = true;
      updateShotSelectionVisual(cb.closest('li'), true);
    });
  }

  function applyLayoutColumns(count, { updateControl = true } = {}) {
    let cols = parseInt(count, 10);
    if (Number.isNaN(cols)) cols = state.layoutColumns || 1;
    cols = Math.min(3, Math.max(1, cols));
    shotList.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
    state.layoutColumns = cols;
    if (updateControl && layoutSelect) {
      const desiredValue = String(cols);
      if (layoutSelect.value !== desiredValue) {
        layoutSelect.value = desiredValue;
      }
    }
  }

  const pastelPalette = [
    '#FDE2E4', '#E2F0CB', '#FFF5BA', '#CCE2F1', '#E5D9F2', '#FADDE1', '#D8F3DC', '#FFE0AC', '#E0E7FF', '#F8EDEB',
  ];

  function normalizeSceneKey(scene) {
    return (scene || '').replace(/\s+/g, ' ').trim().toUpperCase();
  }

  function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash);
  }

  function ensureSceneColor(scene) {
    const key = normalizeSceneKey(scene);
    if (!key) return null;
    if (!state.sceneColors[key]) {
      const idx = hashString(key) % pastelPalette.length;
      state.sceneColors[key] = pastelPalette[idx];
    }
    return state.sceneColors[key];
  }

  function applySceneColor(li, scene) {
    const color = ensureSceneColor(scene) || 'rgba(241, 245, 249, 0.9)';
    li.style.backgroundColor = color;
    li.style.setProperty('--scene-color', color);
  }

  function saveLocal() {
    const data = collectData();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadLocal() {
    let raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      raw = localStorage.getItem(LEGACY_STORAGE_KEY);
      if (raw) {
        localStorage.setItem(STORAGE_KEY, raw);
        localStorage.removeItem(LEGACY_STORAGE_KEY);
      }
    }
    if (!raw) return;
    try { hydrate(JSON.parse(raw)); } catch {}
  }

  function collectData() {
    return {
      meta: {
  title: projTitle.value.trim(),
  director: director.value.trim(),
  productionCompany: productionCompany.value.trim(),
  dop: dop.value.trim(),
  producer: producer.value.trim(),
  shootSchedule: shootSchedule.value.trim(),
  notes: projNotes.value.trim(),
      },
      layout: {
        columns: state.layoutColumns,
      },
      sceneColors: { ...state.sceneColors },
      shots: state.shots.map(s => ({...s}))
    };
  }

  function hydrate(data) {
    isHydrating = true;
  projTitle.value = data?.meta?.title || '';
  director.value = data?.meta?.director || '';
  productionCompany.value = data?.meta?.productionCompany || '';
  dop.value = data?.meta?.dop || '';
  producer.value = data?.meta?.producer || '';
  shootSchedule.value = data?.meta?.shootSchedule || '';
  projNotes.value = data?.meta?.notes || '';
    state.sceneColors = { ...(data?.sceneColors || {}) };
    applyLayoutColumns(data?.layout?.columns ?? state.layoutColumns, { updateControl: true });
    resetShots({ preserveSceneColors: true });
    (data?.shots || []).forEach(addShotFromData);
    isHydrating = false;
  }

  function resetShots(options = {}) {
    clearShotSelection();
    if (!options.preserveSceneColors) {
      state.sceneColors = {};
    }
    state.shots = [];
    shotList.innerHTML = '';
  }

  function addShotFromData(s) {
    const li = tmpl.content.firstElementChild.cloneNode(true);
    li.dataset.id = s.id || (s.id = uid());
    const sceneInput = li.querySelector('.scene');
    const shotNumInput = li.querySelector('.shotnum');
    const typeInput = li.querySelector('.type');
    const lensInput = li.querySelector('.lens');
    const moveInput = li.querySelector('.move');
    const descInput = li.querySelector('.desc');
    const charsInput = li.querySelector('.chars');
    const locationInput = li.querySelector('.location');
    const shootDateInput = li.querySelector('.shootdate');
    const equipmentInput = li.querySelector('.equipment');
    const propsInput = li.querySelector('.props');
    const notesInput = li.querySelector('.notes');
    const selectShot = li.querySelector('.select-shot');
    const toggleFoldBtn = li.querySelector('.btnToggleFold');

    sceneInput.value = s.scene || '';
    shotNumInput.value = s.number || state.shots.length + 1;
    typeInput.value = s.type || 'Wide';
    lensInput.value = s.lens || '35mm';
    moveInput.value = s.move || 'Locked';
    descInput.value = s.desc || '';
    charsInput.value = s.chars || '';
    locationInput.value = s.location || '';
    shootDateInput.value = s.shootDate || s.shootingDate || '';
    equipmentInput.value = s.equipment || '';
    propsInput.value = s.props || '';
    notesInput.value = s.notes || '';

    updateShotTitle(li);
    applySceneColor(li, sceneInput.value);

    if (selectShot) {
      selectShot.checked = false;
      updateShotSelectionVisual(li, false);
      selectShot.addEventListener('change', () => {
        updateShotSelectionVisual(li, selectShot.checked);
      });
    }

    setShotFolded(li, s.folded);

    if (toggleFoldBtn) {
      toggleFoldBtn.addEventListener('click', () => {
        const next = li.dataset.folded !== 'true';
        setShotFolded(li, next);
        persistFromDOM();
      });
    }

    // Handle image display
    const frameImg = li.querySelector('.frame-image');
    const framePlaceholder = li.querySelector('.frame-placeholder');
    const removeBtn = li.querySelector('.remove-image');
    
    if (s.imageData) {
      frameImg.src = s.imageData;
      frameImg.classList.remove('hidden');
      framePlaceholder.classList.add('hidden');
      removeBtn.classList.remove('hidden');
      removeBtn.classList.add('flex');
    }

    // Image upload handler
    li.querySelector('.image-upload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (event) => {
          frameImg.src = event.target.result;
          frameImg.classList.remove('hidden');
          framePlaceholder.classList.add('hidden');
          removeBtn.classList.remove('hidden');
          removeBtn.classList.add('flex');
          
          // Update state
          const shotId = li.dataset.id;
          const shotIndex = indexOfShot(shotId);
          if (shotIndex > -1) {
            state.shots[shotIndex].imageData = event.target.result;
            saveLocal();
          }
        };
        reader.readAsDataURL(file);
      }
    });

    // Remove image handler
    removeBtn.addEventListener('click', () => {
      frameImg.src = '';
      frameImg.classList.add('hidden');
      framePlaceholder.classList.remove('hidden');
      removeBtn.classList.add('hidden');
      removeBtn.classList.remove('flex');
      
      // Update state
      const shotId = li.dataset.id;
      const shotIndex = indexOfShot(shotId);
      if (shotIndex > -1) {
        delete state.shots[shotIndex].imageData;
        saveLocal();
      }
    });

    // Bind buttons
    li.querySelector('.btnDup').addEventListener('click', () => {
      const current = readShotFromLI(li);
      const clone = { ...current, id: uid() };
      state.shots.splice(indexOfShot(s.id) + 1, 0, clone);
      renderAll();
      saveLocal();
    });

    li.querySelector('.btnDelete').addEventListener('click', () => {
      state.shots = state.shots.filter(x => x.id !== s.id);
      li.remove();
      renumber();
      saveLocal();
    });

    // Track changes
    li.querySelectorAll('.inp').forEach(el => {
      el.addEventListener('input', () => {
        if (el.classList.contains('scene') || el.classList.contains('shotnum')) {
          updateShotTitle(li);
        }
        if (el.classList.contains('scene')) {
          applySceneColor(li, el.value);
        }
        persistFromDOM();
      });
    });

    shotList.appendChild(li);
    updateShotTitle(li);
    state.shots.push({ id: s.id, ...readShotFromLI(li) });
  }

  function readShotFromLI(li) {
    const frameImg = li.querySelector('.frame-image');
    const data = {
      scene: li.querySelector('.scene').value,
      number: li.querySelector('.shotnum').value,
      type: li.querySelector('.type').value,
      lens: li.querySelector('.lens').value,
      move: li.querySelector('.move').value,
      desc: li.querySelector('.desc').value,
      chars: li.querySelector('.chars').value,
      location: li.querySelector('.location').value,
      shootDate: li.querySelector('.shootdate').value,
      equipment: li.querySelector('.equipment').value,
      props: li.querySelector('.props').value,
      notes: li.querySelector('.notes').value,
      folded: li.dataset.folded === 'true',
    };
    
    if (frameImg.src && !frameImg.classList.contains('hidden')) {
      data.imageData = frameImg.src;
    }
    
    return data;
  }

  function persistFromDOM() {
    if (isHydrating) return;
    // Walk DOM list order to persist state
    state.shots = Array.from(shotList.children).map(li => ({ id: li.dataset.id, ...readShotFromLI(li) }));
    renumber();
    saveLocal();
  }

  function renumber() {
    Array.from(shotList.children).forEach((li, i) => {
      li.querySelector('.shotnum').value = i + 1;
      updateShotTitle(li);
      const idx = indexOfShot(li.dataset.id);
      if (idx > -1) state.shots[idx].number = i + 1;
    });
  }

  function indexOfShot(id) { return state.shots.findIndex(s => s.id === id); }

  function renderAll() {
    shotList.innerHTML = '';
    const existing = [...state.shots];
    state.shots = [];
    existing.forEach(addShotFromData);
  }

  function newShot(preset={}) {
    addShotFromData({
      id: uid(),
      scene: preset.scene || '',
      type: preset.type || 'Wide',
      lens: preset.lens || '35mm',
      move: preset.move || 'Locked',
      desc: preset.desc || '',
      chars: preset.chars || '',
      location: preset.location || '',
      shootDate: preset.shootDate || '',
      equipment: preset.equipment || '',
      props: preset.props || '',
      notes: preset.notes || '',
      folded: preset.folded || false,
    });
    saveLocal();
  }

  // --- Drag to reorder ---
  let dragSrcEl = null;
  let ghost;

  function addDragHandlers(li) {
    const h = li.querySelector('.handle');
    h.addEventListener('pointerdown', (e) => {
      dragSrcEl = li;
      ghost = li.cloneNode(true);
      ghost.classList.add('opacity-50');
      ghost.style.pointerEvents = 'none';
      li.parentNode.insertBefore(ghost, li.nextSibling);
      li.classList.add('ring-2','ring-emerald-500');
      document.addEventListener('pointermove', onMove);
      document.addEventListener('pointerup', onUp, { once: true });
    });
  }

  function onMove(e) {
    const y = e.clientY;
    const items = Array.from(shotList.children).filter(el => el !== dragSrcEl);
    for (const item of items) {
      const rect = item.getBoundingClientRect();
      const before = y < rect.top + rect.height / 2;
      if (before) { shotList.insertBefore(ghost, item); break; }
      if (item === items[items.length-1]) { shotList.appendChild(ghost); }
    }
  }

  function onUp() {
    const moved = dragSrcEl;
    if (moved) {
      moved.classList.remove('ring-2','ring-emerald-500');
      shotList.insertBefore(moved, ghost);
    }
    if (ghost) ghost.remove();
    ghost = null;
    dragSrcEl = null;
    persistFromDOM();
    if (moved) {
      const cb = moved.querySelector('.select-shot');
      if (cb) updateShotSelectionVisual(moved, cb.checked);
    }
    document.removeEventListener('pointermove', onMove);
  }

  // Observe list for new items to wire drag
  const mo = new MutationObserver(() => {
    Array.from(shotList.children).forEach(addDragHandlers);
  });
  mo.observe(shotList, { childList: true });

  // --- Import/Export ---
  btnExport.addEventListener('click', () => {
    const data = collectData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (data.meta.title || 'storyboard') + '.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  btnImport.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files[0]; if (!f) return;
    const reader = new FileReader();
    reader.onload = () => { try { hydrate(JSON.parse(reader.result)); saveLocal(); } catch (e) { alert('Invalid JSON'); } };
    reader.readAsText(f);
    fileInput.value = '';
  });

  btnPrint.addEventListener('click', () => {
    window.print();
  });

  btnReset.addEventListener('click', () => {
    const confirmed = confirm('This will delete all shots and production data for this storyboard. Continue?');
    if (!confirmed) return;

    // Clear meta fields
    projTitle.value = '';
    director.value = '';
    productionCompany.value = '';
    dop.value = '';
    producer.value = '';
    shootSchedule.value = '';
    projNotes.value = '';

    // Clear shots and state
    resetShots();
    clearShotSelection();
    saveLocal();
  });

  if (btnSelectAll) {
    btnSelectAll.addEventListener('click', () => {
      if (!shotList.children.length) {
        alert('No shots are available to select yet.');
        return;
      }
      selectAllShots();
    });
  }

  if (btnFoldSelected) {
    btnFoldSelected.addEventListener('click', () => {
      const items = getSelectedShotLis();
      if (!items.length) {
        alert('Select at least one shot to fold.');
        return;
      }
      items.forEach(li => setShotFolded(li, true));
      clearShotSelection();
      persistFromDOM();
    });
  }

  if (btnUnfoldSelected) {
    btnUnfoldSelected.addEventListener('click', () => {
      const items = getSelectedShotLis();
      if (!items.length) {
        alert('Select at least one shot to unfold.');
        return;
      }
      items.forEach(li => setShotFolded(li, false));
      clearShotSelection();
      persistFromDOM();
    });
  }

  if (btnClearSelection) {
    btnClearSelection.addEventListener('click', () => {
      clearShotSelection();
    });
  }

  if (layoutSelect) {
    layoutSelect.addEventListener('change', (e) => {
      applyLayoutColumns(e.target.value);
      if (!isHydrating) saveLocal();
    });
  }

  // --- New shot ---
  btnNew.addEventListener('click', () => newShot());

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
    if (e.key.toLowerCase() === 'n') { e.preventDefault(); newShot(); }
    if (e.key.toLowerCase() === 'e') { e.preventDefault(); btnExport.click(); }
    if (e.key.toLowerCase() === 'p') { e.preventDefault(); btnPrint.click(); }
  });

  // --- Init ---
  loadLocal();
  applyLayoutColumns(state.layoutColumns, { updateControl: true });
  if (!projTitle.value) projTitle.value = 'Project Title (working title)';

  // Persist meta edits
  [projTitle, director, productionCompany, dop, producer, shootSchedule, projNotes].forEach(el => el.addEventListener('input', saveLocal));
  </script>

  <footer class="max-w-7xl mx-auto p-6 text-center text-slate-500 text-xs">
    Built as a single HTML file â€“ host on GitHub Pages or Netlify. Â© You.
  </footer>
</body>
</html>
